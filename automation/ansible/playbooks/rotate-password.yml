---
# Ansible Playbook: Rotate Database Passwords
# Purpose: Demonstrate automated password rotation (CPM equivalent)
# Usage: ansible-playbook playbooks/rotate-password.yml

- name: Rotate Database Passwords using Vault
  hosts: localhost
  gather_facts: yes
  vars:
    vault_addr: "{{ lookup('env', 'VAULT_ADDR') | default('http://localhost:8200', true) }}"
    vault_token: "{{ lookup('env', 'VAULT_TOKEN') | default('root-token-change-me', true) }}"
    databases:
      - name: "postgresql"
        static_role: "postgres-root"
      - name: "mysql"
        static_role: "mysql-root"

  tasks:
    - name: Check Vault accessibility
      uri:
        url: "{{ vault_addr }}/v1/sys/health"
        method: GET
        status_code: 200
      register: vault_health

    - name: Display pre-rotation timestamp
      debug:
        msg: "Starting password rotation at {{ ansible_date_time.iso8601 }}"

    - name: Read current credentials before rotation
      uri:
        url: "{{ vault_addr }}/v1/database/static-creds/{{ item.static_role }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: [200, 404]
      register: pre_rotation_creds
      loop: "{{ databases }}"
      loop_control:
        label: "{{ item.name }}"
      failed_when: false

    - name: Display current credentials
      debug:
        msg: "{{ item.item.name }}: Username={{ item.json.data.username | default('N/A') }}"
      loop: "{{ pre_rotation_creds.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: item.status == 200

    - name: Rotate root credentials for each database
      uri:
        url: "{{ vault_addr }}/v1/database/rotate-root/{{ item.name }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: [200, 204]
      register: rotation_result
      loop: "{{ databases }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Wait for rotation to complete
      pause:
        seconds: 2

    - name: Read new credentials after rotation
      uri:
        url: "{{ vault_addr }}/v1/database/static-creds/{{ item.static_role }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: 200
      register: post_rotation_creds
      loop: "{{ databases }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Display new credentials
      debug:
        msg:
          - "Database: {{ item.item.name }}"
          - "Username: {{ item.json.data.username }}"
          - "Password: {{ item.json.data.password }}"
          - "Last Vault Rotation: {{ item.json.data.last_vault_rotation | default('N/A') }}"
          - "Rotation Period: {{ item.json.data.rotation_period | default('N/A') }}s"
      loop: "{{ post_rotation_creds.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Test database connectivity with new credentials (PostgreSQL)
      postgresql_ping:
        login_host: localhost
        login_port: 5432
        login_user: "{{ (post_rotation_creds.results | selectattr('item.name', 'equalto', 'postgresql') | first).json.data.username }}"
        login_password: "{{ (post_rotation_creds.results | selectattr('item.name', 'equalto', 'postgresql') | first).json.data.password }}"
        db: testdb
      register: pg_test
      failed_when: false
      when: "'postgresql' in (databases | map(attribute='name') | list)"

    - name: Test database connectivity with new credentials (MySQL)
      community.mysql.mysql_info:
        login_host: localhost
        login_port: 3306
        login_user: "{{ (post_rotation_creds.results | selectattr('item.name', 'equalto', 'mysql') | first).json.data.username }}"
        login_password: "{{ (post_rotation_creds.results | selectattr('item.name', 'equalto', 'mysql') | first).json.data.password }}"
      register: mysql_test
      failed_when: false
      when: "'mysql' in (databases | map(attribute='name') | list)"

    - name: Read audit log for rotation events
      shell: |
        docker exec vault tail -n 20 /vault/logs/audit.log | grep "rotate-root" || echo "No rotation events found"
      register: audit_log
      changed_when: false
      failed_when: false

    - name: Display audit log entries
      debug:
        msg: "{{ audit_log.stdout_lines }}"
      when: audit_log.stdout_lines is defined

    - name: Rotation summary
      debug:
        msg:
          - "Password Rotation Complete!"
          - "=========================="
          - "Timestamp: {{ ansible_date_time.iso8601 }}"
          - "Databases Rotated: {{ databases | length }}"
          - "PostgreSQL: {{ 'SUCCESS' if (pg_test.skipped is not defined and pg_test.failed is defined and not pg_test.failed) else 'SKIPPED/FAILED' }}"
          - "MySQL: {{ 'SUCCESS' if (mysql_test.skipped is not defined and mysql_test.failed is defined and not mysql_test.failed) else 'SKIPPED/FAILED' }}"
          - ""
          - "All database passwords have been rotated."
          - "Old passwords are now invalid."
          - "Applications must retrieve new credentials from Vault."
          - ""
          - "Verify rotation in audit log:"
          - "  docker exec vault cat /vault/logs/audit.log | grep rotate-root"

    - name: Save rotation report
      copy:
        content: |
          Password Rotation Report
          ========================
          Generated: {{ ansible_date_time.iso8601 }}
          Vault Address: {{ vault_addr }}

          Rotated Databases:
          {% for item in post_rotation_creds.results %}
          - {{ item.item.name }}:
            Username: {{ item.json.data.username }}
            Rotation Period: {{ item.json.data.rotation_period | default('N/A') }}s
            Next Rotation: {{ item.json.data.ttl | default('N/A') }}s
          {% endfor %}

          Status:
          - PostgreSQL Connection: {{ 'OK' if (pg_test.skipped is not defined and pg_test.failed is defined and not pg_test.failed) else 'SKIPPED/FAILED' }}
          - MySQL Connection: {{ 'OK' if (mysql_test.skipped is not defined and mysql_test.failed is defined and not mysql_test.failed) else 'SKIPPED/FAILED' }}

          Notes:
          - All credentials have been rotated
          - Old passwords are invalid
          - Retrieve current credentials from Vault before connecting
        dest: "/tmp/password-rotation-{{ ansible_date_time.epoch }}.txt"
      delegate_to: localhost

    - name: Report location
      debug:
        msg: "Rotation report saved to: /tmp/password-rotation-{{ ansible_date_time.epoch }}.txt"
